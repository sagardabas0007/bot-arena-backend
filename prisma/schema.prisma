generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Agent {
  id          String   @id @default(dbgenerated("(uuid_generate_v4())::text"))
  name        String
  apiKey      String   @unique
  botId       String   @unique
  description String?
  skillRating Int      @default(1000)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  Bot         Bot      @relation(fields: [botId], references: [id])

  @@index([apiKey])
}

model Arena {
  id            String   @id @default(dbgenerated("(uuid_generate_v4())::text"))
  tier          Int      @unique
  name          String
  entryFee      Decimal  @db.Decimal(10, 2)
  difficulty    String
  gridRows      Int
  gridCols      Int
  obstacleCount Int
  timeLimit     Int
  description   String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())
  Game          Game[]

  @@index([tier])
}

model Bot {
  id            String    @id @default(dbgenerated("(uuid_generate_v4())::text"))
  walletAddress String    @unique
  username      String
  characterId   Int
  totalWins     Int       @default(0)
  totalGames    Int       @default(0)
  totalEarnings Decimal   @default(0) @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now())
  Agent         Agent?
  BotGame       BotGame[]
  Game          Game[]
  Move          Move[]

  @@index([walletAddress])
}

model BotGame {
  id             String   @id @default(dbgenerated("(uuid_generate_v4())::text"))
  botId          String
  gameId         String
  position       Int
  completionTime Int?
  collisions     Int      @default(0)
  level1Time     Int?
  level2Time     Int?
  level3Time     Int?
  eliminated     Boolean  @default(false)
  eliminatedAt   Int?
  createdAt      DateTime @default(now())
  Bot            Bot      @relation(fields: [botId], references: [id])
  Game           Game     @relation(fields: [gameId], references: [id])

  @@unique([botId, gameId])
  @@index([botId])
  @@index([gameId])
}

model Game {
  id           String     @id @default(dbgenerated("(uuid_generate_v4())::text"))
  arenaId      String
  status       GameStatus @default(WAITING)
  currentLevel Int        @default(1)
  prizePool    Decimal    @db.Decimal(10, 2)
  winnerId     String?
  startTime    DateTime?
  endTime      DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now())
  BotGame      BotGame[]
  Arena        Arena      @relation(fields: [arenaId], references: [id])
  Bot          Bot?       @relation(fields: [winnerId], references: [id])
  Move         Move[]

  @@index([arenaId, status])
  @@index([status])
}

model Move {
  id          String   @id @default(dbgenerated("(uuid_generate_v4())::text"))
  gameId      String
  botId       String
  level       Int
  fromX       Int
  fromY       Int
  toX         Int
  toY         Int
  moveNumber  Int
  isCollision Boolean  @default(false)
  timestamp   DateTime @default(now())
  Bot         Bot      @relation(fields: [botId], references: [id])
  Game        Game     @relation(fields: [gameId], references: [id])

  @@index([gameId, botId])
}

enum GameStatus {
  WAITING
  LEVEL_1
  LEVEL_2
  LEVEL_3
  COMPLETED
  CANCELLED
}
