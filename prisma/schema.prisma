generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Arena {
  id            String   @id @default(uuid())
  tier          Int      @unique
  name          String
  entryFee      Decimal  @db.Decimal(10, 2)
  difficulty    String
  gridRows      Int
  gridCols      Int
  obstacleCount Int
  timeLimit     Int
  description   String
  isActive      Boolean  @default(true)
  games         Game[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tier])
}

model Game {
  id           String     @id @default(uuid())
  arenaId      String
  arena        Arena      @relation(fields: [arenaId], references: [id])
  status       GameStatus @default(WAITING)
  currentLevel Int        @default(1)
  prizePool    Decimal    @db.Decimal(10, 2)
  winnerId     String?
  winner       Bot?       @relation("GameWinner", fields: [winnerId], references: [id])
  startTime    DateTime?
  endTime      DateTime?
  participants BotGame[]
  moves        Move[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([arenaId, status])
  @@index([status])
}

model Bot {
  id            String    @id @default(uuid())
  walletAddress String    @unique
  username      String
  characterId   Int
  totalWins     Int       @default(0)
  totalGames    Int       @default(0)
  totalEarnings Decimal   @default(0) @db.Decimal(10, 2)
  gamesPlayed   BotGame[]
  wonGames      Game[]    @relation("GameWinner")
  moves         Move[]
  agent         Agent?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([walletAddress])
}

model Agent {
  id          String   @id @default(uuid())
  name        String
  apiKey      String   @unique
  botId       String   @unique
  bot         Bot      @relation(fields: [botId], references: [id])
  description String?
  skillRating Int      @default(1000)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([apiKey])
}

model BotGame {
  id             String   @id @default(uuid())
  botId          String
  bot            Bot      @relation(fields: [botId], references: [id])
  gameId         String
  game           Game     @relation(fields: [gameId], references: [id])
  position       Int
  completionTime Int?
  collisions     Int      @default(0)
  level1Time     Int?
  level2Time     Int?
  level3Time     Int?
  eliminated     Boolean  @default(false)
  eliminatedAt   Int?
  createdAt      DateTime @default(now())

  @@unique([botId, gameId])
  @@index([gameId])
  @@index([botId])
}

model Move {
  id          String   @id @default(uuid())
  gameId      String
  game        Game     @relation(fields: [gameId], references: [id])
  botId       String
  bot         Bot      @relation(fields: [botId], references: [id])
  level       Int
  fromX       Int
  fromY       Int
  toX         Int
  toY         Int
  moveNumber  Int
  isCollision Boolean  @default(false)
  timestamp   DateTime @default(now())

  @@index([gameId, botId])
}

enum GameStatus {
  WAITING
  LEVEL_1
  LEVEL_2
  LEVEL_3
  COMPLETED
  CANCELLED
}
